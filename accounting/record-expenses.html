<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Records Expenses</title>
    <style>
        .tag {
            display: inline-block;
            padding: 5px 10px;
            margin: 5px;
            background-color: #e0e0e0;
            border-radius: 5px;
            cursor: pointer;
        }
        .tag.selected {
            background-color: #ff4081;
            color: white;
        }
        #calculator {
            display: grid;
            place-items: center;
            margin-top: 10px;
        }
        #keypad {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }
        .calc-key {
            padding: 15px;
            font-size: 20px;
            cursor: pointer;
        }
        button.calc-key{
            border-radius: 0px;
            border: 0px;
        }
      
        #content-input, #content-amount, #content-remark {
            font-size: 14px;
            padding: 5px;
            margin-bottom: 10px;
            width: 200px;
            /* max-width: 50vw; */
        }
        #content-input {
            width: calc(100% - 20px);
        }
        #content-amount {
            text-align: right;
        }
        #content-remark {
            margin-top: 10px;
            width: 300px;
            height: 100px;
            /* resize: none; */
        }
        #tag-container {
            width: 100%;
            /* max-width: 50vw; */
        }
        #container {
            display: flex;
            justify-content: space-around;
            padding-top: 10px;
            flex-wrap: wrap;
        }

        #container-bottom {
            flex-basis: 100%;
        }
    </style>
</head>
<body>
    <b style="color:#ccc;">v3.2.1</b>
    
    <div id="container">
        <div id="container-left">
            <!--<label for="content-input">明目:</label>-->
            <input type="text" id="content-input" placeholder="例如：[吃饭]">
            <div id="tag-container">
            </div>
            <!--<label for="content-amount">金额:</label>-->
            <div id="calculator">
                <input type="text" id="content-amount" placeholder="输入金额" readonly>
                <div id="keypad">
                    <button class="calc-key">1</button>
                    <button class="calc-key">2</button>
                    <button class="calc-key">3</button>
                    <button class="calc-key">+</button>
                    <button class="calc-key">4</button>
                    <button class="calc-key">5</button>
                    <button class="calc-key">6</button>
                    <button class="calc-key">-</button>
                    <button class="calc-key">7</button>
                    <button class="calc-key">8</button>
                    <button class="calc-key">9</button>
                    <button class="calc-key">*</button>
                    <button class="calc-key">0</button>
                    <button class="calc-key">/</button>
                    <button class="calc-key">C</button>
                    <button class="calc-key">=</button>
                </div>
            </div>
        </div>
        <div id="container-right">
            <textarea id="content-remark"></textarea>
        </div>

        <div id="container-bottom">
            
            <input type="text" id="content-location">
        </div>
    </div>
    <button id="submit-btn" class="submit-btn disabled" onclick="submitData()">提交</button>
    <p id="o"></p>
    <p id="record"></p>
    <script>
        let tags = ['餐饮美食','日常购物','医疗保健','交通出行','休闲娱乐','服饰美容','旅游放松','水电网','人情往来','家居硬体','房贷房租物管','车贷','宠物','其他']; 
        let selectedTag = null; 

        
        function renderTags() {
            const tagContainer = document.getElementById("tag-container");
            tagContainer.innerHTML = "";
            tags.forEach(tag => {
                const tagElement = document.createElement("div");
                tagElement.classList.add("tag");
                tagElement.textContent = tag;
                tagElement.onclick = () => selectTag(tag);
                if (tag === selectedTag) {
                    tagElement.classList.add("selected");
                }
                tagContainer.appendChild(tagElement);
            });
        }

        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function(position) {
                const latitude = position.coords.latitude;
                const longitude = position.coords.longitude;
                // document.getElementById("content-location").value = `Latitude: ${latitude}, Longitude: ${longitude}`;
                document.getElementById("content-location").value = `https://maps.google.com/maps?q=${latitude},${longitude}`;
            });
        } else {
            document.getElementById("content-location").value = "Geolocation is not supported by this browser.";
        }
        
        function selectTag(tagName) {
            selectedTag = tagName;
            renderTags();
            toggleSubmitButton();
        }

        
        function toggleSubmitButton() {
            const contentInput = document.getElementById("content-input").value;
            const submitButton = document.getElementById("submit-btn");
            if (contentInput.trim() !== '' && selectedTag !== null){
                submitButton.classList.remove("disabled");
            } else {
                submitButton.classList.add("disabled");
            }
        }

        
        function submitData() {
            const title = document.getElementById("content-input").value;
            const amount = document.getElementById("content-amount").value;
            const remark = document.getElementById("content-remark").value;
            const location = document.getElementById("content-location").value;
            const separator = '|'
            // const contentInput = document.getElementById("content-input").value;
            // const [title, amount] = contentInput.split(" ");
            let submitted_value = title+separator+amount+separator+selectedTag+separator+remark+separator+location;
            const shortcutUrl = 'shortcuts://run-shortcut?name=WebRecordExpenses&input=text&text='+encodeURIComponent(submitted_value);
            // sendObjectMessage(`${encodeURIComponent(title+" "+amount+" "+selectedTag)}`);
            window.location.href = shortcutUrl;
            document.getElementById("o").innerHTML = '<a href="'+shortcutUrl+'">'+shortcutUrl+'</a>';
            document.getElementById("record").appendChild('<b>'+submitted_value+'</b><br/>');
            document.getElementById("content-input").value = '';
            document.getElementById("content-amount").value = 0;
            document.getElementById("content-remark").value = '';
            selectedTag = null;
            selectTag('');

        }
        function cleanPageAndLeave() {
            var myWindow = window.open("", "_self");
            myWindow.document.write("");
            setTimeout (function() {myWindow.close();},1000);
        }

        async function fetchDataAndExtractTags() {
            const submitButton = document.getElementById("submit-btn");
            submitButton.classList.add("disabled");
            renderTags();
        }
        
        let possibleTag = {
            '餐饮美食': ['dinner','吃饭','晚餐','brunch','breakfast','lunch','午餐','早午餐'],
            '交通出行': ['打油'],
        };
        function findTagKey(inputText) {
            for (let tag in possibleTag) {
                // 检查输入文本是否包含当前标签的任何词汇
                if (possibleTag[tag].some(keyword => inputText.includes(keyword))) {
                    return tag;
                }
            }
            // 如果没有找到匹配的标签，返回空字符串
            return '';
        }

        function toggleNumberInput(event){
        // 检查是否按下了 Return 键（keyCode为13），且不是最后一个输入框
            let inputValue = document.getElementById("content-input").value;
            let relevantKey = findTagKey(inputValue);
            if (selectedTag != relevantKey){
                selectedTag = relevantKey;
                renderTags();
            }
            if (event.keyCode === 13) {
                // 阻止默认行为（防止换行）
                event.preventDefault();
                // 将焦点移动到下一个输入框
                document.getElementById("content-amount").focus();
            }
        }
        document.querySelectorAll('.calc-key').forEach(button => {
            button.addEventListener('click', function() {
                const inputField = document.getElementById('content-amount');
                if (this.textContent === 'C') {
                    inputField.value = '';
                } else if (this.textContent === '=') {
                    try {
                        inputField.value = eval(inputField.value);
                    } catch (e) {
                        inputField.value = 'Error';
                    }
                } else {
                    inputField.value += this.textContent;
                }
            });
        });

        window.onload = fetchDataAndExtractTags;

        document.getElementById("content-input").addEventListener("keydown", toggleNumberInput);
        document.getElementById("content-input").addEventListener("input", toggleSubmitButton);
    </script>
</body>
</html>
