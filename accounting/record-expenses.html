<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Records Expenses</title>
    <style>
        .tag {
            display: inline-block;
            padding: 5px 10px;
            margin: 5px;
            background-color: #e0e0e0;
            border-radius: 5px;
            cursor: pointer;
        }
        .tag.selected {
            background-color: #ff4081;
            color: white;
        }
    </style>
</head>
<body>
    <b style="color:#ccc;">v3.1.1</b>
    <br><br>
    <label for="content-input">明目:</label>
    <input type="text" id="content-input" placeholder="明目 例如：[吃饭]">
    <br>
    <label for="content-number">金额:</label>
	<input type="number" id="content-number" placeholder="金额，例如：[12]">
    <br><br>
    <div id="tag-container">
    </div>
    <br>
    <button id="submit-btn" class="submit-btn disabled" onclick="submitData()">提交</button>
    <p id="o"></p>
    <p id="record"></p>
    <script>
        let tags = ['餐饮美食','日常购物','医疗保健','交通出行','休闲娱乐','服饰美容','旅游放松','水电网','人情往来','家居硬体','房贷房租物管','车贷','宠物','其他']; 
        let selectedTag = null; 

        
        function renderTags() {
            const tagContainer = document.getElementById("tag-container");
            tagContainer.innerHTML = "";
            tags.forEach(tag => {
                const tagElement = document.createElement("div");
                tagElement.classList.add("tag");
                tagElement.textContent = tag;
                tagElement.onclick = () => selectTag(tag);
                if (tag === selectedTag) {
                    tagElement.classList.add("selected");
                }
                tagContainer.appendChild(tagElement);
            });
        }

        
        function selectTag(tagName) {
            selectedTag = tagName;
            renderTags();
            toggleSubmitButton();
        }

        
        function toggleSubmitButton() {
            const contentInput = document.getElementById("content-input").value;
            const submitButton = document.getElementById("submit-btn");
            if (contentInput.trim() !== '' && selectedTag !== null){
                submitButton.classList.remove("disabled");
            } else {
                submitButton.classList.add("disabled");
            }
        }

        
        function submitData() {
            const title = document.getElementById("content-input").value;
            const amount = document.getElementById("content-number").value;
            // const contentInput = document.getElementById("content-input").value;
            // const [title, amount] = contentInput.split(" ");
            let submitted_value = title+' '+amount+' '+selectedTag;
            const shortcutUrl = 'shortcuts://run-shortcut?name=WebRecordExpenses&input=text&text='+encodeURIComponent(submitted_value);
            document.getElementById("o").innerHTML = '<a href="'+shortcutUrl+'">'+shortcutUrl+'</a>';
            document.getElementById("record").appendChild('<b>'+submitted_value+'</b><br/>');
            // sendObjectMessage(`${encodeURIComponent(title+" "+amount+" "+selectedTag)}`);
            window.location.href = shortcutUrl;
            document.getElementById("content-input").value = '';
            document.getElementById("content-number").value = 0;
            selectedTag = null;
            selectTag('');

        }
        function cleanPageAndLeave() {
            var myWindow = window.open("", "_self");
            myWindow.document.write("");
            setTimeout (function() {myWindow.close();},1000);
        }

        async function fetchDataAndExtractTags() {
            const submitButton = document.getElementById("submit-btn");
            submitButton.classList.add("disabled");
            renderTags();
        }
        
        let possibleTag = {
            '餐饮美食': ['dinner','吃饭','晚餐','brunch','breakfast','lunch','午餐','早午餐'],
            '交通出行': ['打油'],
        };
        function findTagKey(inputText) {
            for (let tag in possibleTag) {
                // 检查输入文本是否包含当前标签的任何词汇
                if (possibleTag[tag].some(keyword => inputText.includes(keyword))) {
                    return tag;
                }
            }
            // 如果没有找到匹配的标签，返回空字符串
            return '';
        }

        function toggleNumberInput(event){
        // 检查是否按下了 Return 键（keyCode为13），且不是最后一个输入框
            let inputValue = document.getElementById("content-input").value;
            let relevantKey = findTagKey(inputValue);
            if (selectedTag != relevantKey){
                selectedTag = relevantKey;
                renderTags();
            }
            if (event.keyCode === 13) {
                // 阻止默认行为（防止换行）
                event.preventDefault();
                // 将焦点移动到下一个输入框
                document.getElementById("content-number").focus();
            }
            


        }

        window.onload = fetchDataAndExtractTags;

        document.getElementById("content-input").addEventListener("keydown", toggleNumberInput);
        document.getElementById("content-input").addEventListener("input", toggleSubmitButton);
    </script>
</body>
</html>
